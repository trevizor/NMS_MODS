<!-- High Dynamic Range (HDR) utf-8Shading Pipeline -->
<Pipeline>
  <Setup>
    <ScaleInfo resScalingDefault="true" />

    <RenderTarget id="SHADOWBUF"   depthBuf="true"  numColBufs="0"  format="RGBA8" depthFormat="DEPTH16" scale="0.75" width="5760" height="1920" maxSamples="0" shadow="true" hasMips="false" numUniformBuffers="3" crossPipeShareId="SHADOW_SHARED" />
    <RenderTarget id="SHADOWBUF_DS"   depthBuf="true"  numColBufs="0"  format="RED16F" depthFormat="DEPTH16" scale="1.0" width="2880" height="960" maxSamples="0" shadow="true" hasMips="false" numUniformBuffers="1" esramPageDepthBuf="215" />

    <RenderTarget id="GBUFFER_BIL" platforms="ORBIS|XBOX"           depthBuf="false" numColBufs="4"  format0="RGBA8" format1="RG8"   format2="RGB10A2" format3="RGBA8" scale="1.0" maxSamples="0" shareTarget0="GBUFFER"  shareBuffer0="0" shareTarget1="GBUFFER" shareBuffer1="1" shareTarget2="GBUFFER" shareBuffer2="2" shareTarget3="GBUFFER" shareBuffer3="3" />
    <RenderTarget id="GBUFFER"     platforms="ORBIS|XBOX"           depthBuf="false" numColBufs="4"  format0="RGBA8" format1="RG8"   format2="RGB10A2" format3="RGBA8" scale="1.0" maxSamples="0" pointSampleColBuf1="true" pointSampleColBuf2="true" pointSampleColBuf3="true"  esramPageColBuf2="215" crossPipeShareId="GBUFFER_SHARED" />
    <RenderTarget id="GBUFFER_BIL" platforms="PC|PROSPERO|SCARLETT" depthBuf="false" numColBufs="4"  format0="RGBA8" format1="RG16"  format2="RGB10A2" format3="RGBA8" scale="1.0" maxSamples="0" shareTarget0="GBUFFER"  shareBuffer0="0" shareTarget1="GBUFFER" shareBuffer1="1" shareTarget2="GBUFFER" shareBuffer2="2" shareTarget3="GBUFFER" shareBuffer3="3" />
    <RenderTarget id="GBUFFER"     platforms="PC|PROSPERO|SCARLETT" depthBuf="false" numColBufs="4"  format0="RGBA8" format1="RG16"  format2="RGB10A2" format3="RGBA8" scale="1.0" maxSamples="0" pointSampleColBuf1="true" pointSampleColBuf2="true" pointSampleColBuf3="true"  esramPageColBuf2="215" crossPipeShareId="GBUFFER_SHARED" />

    <RenderTarget id="TAA_FRONT"    depthBuf="false" numColBufs="3"  format0="R11FG11FB10F" format1="R11FG11FB10F" format2="RGBA8" bilinear="true" scale="1.0" maxSamples="0"  shareTarget0="HDRBUF_1"  shareBuffer0="0" shareTarget1="LENSFINAL_OR_UI_COMBINE_BUF"  shareBuffer1="0" shareBuffer2="-1"  allowDcc="false"  />

    <RenderTarget id="TAA_BACK"    depthBuf="false" numColBufs="3"  format0="R11FG11FB10F" format1="R11FG11FB10F" format2="RGBA8" bilinear="true" scale="1.0" maxSamples="0"  shareTarget0="HDRBUF_1"  shareBuffer0="0" shareTarget1="BACK_LENSFINAL_OR_UI_COMBINE_BUF" shareBuffer1="0" shareBuffer2="-1"  allowDcc="false"  />

    <RenderTarget id="FINAL"            depthBuf="false" numColBufs="2"  format0="R11FG11FB10F" format1="RED8"         bilinear="true" scale="1.0"                                    shareTarget0="HDRBUF_1"  shareBuffer0="0"  shareTarget1="HBAOBUF" shareBuffer1="0"   allowDcc="false"  esramPageColBuf0="215"   />
  
    <RenderTarget id="SUNOUT_0"         depthBuf="false" numColBufs="2"  format0="R11FG11FB10F" format1="R11FG11FB10F" bilinear="true" scale="1.0" maxSamples="0"   shareTarget0="HDRBUF_0"  shareBuffer0="0"  shareTarget1="HDRBUF_1"       shareBuffer1="0" />
   
    <RenderTarget id="BLENDED_ABOVE"    depthBuf="false" numColBufs="2"  format0="R11FG11FB10F" format1="RED8"         bilinear="true" scale="1.0" maxSamples="0"   shareTarget0="HDRBUF_0"  shareBuffer0="0"  shareTarget1="HBAOBUF"        shareBuffer1="0" />   
    
    <RenderTarget id="HDRBUF_0"    depthBuf="false" numColBufs="1"  format="R11FG11FB10F" bilinear="true" scale="1.0" maxSamples="0"   esramPageColBuf0="306" />

    <RenderTarget id="HDRBUF_1"    depthBuf="false" numColBufs="1"  format="R11FG11FB10F" bilinear="true" scale="1.0" maxSamples="0"   esramPageColBuf0="397" allowDcc="false" />
    
    <RenderTarget id="SSR_TRACE"        platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="3"  scale="0.5"     format0="RG16" format1="RED16F" format2="RED8"  shareTarget0="SSR_UVS"  shareBuffer0="0"  shareTarget1="SSR_PDF"  shareBuffer1="0" shareTarget2="SSR_VISIBILITY" shareBuffer2="0" />
    <RenderTarget id="SSR_UVS"          platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5"     format="RG16"  pointSampleColBuf0="true" />
    <RenderTarget id="SSR_PDF"          platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5"     format="RED16F" />
    <RenderTarget id="SSR_VISIBILITY"   platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5"     format="RED8" />
    <RenderTarget id="SSR_REFL_0"       platforms="PC|PROSPERO|SCARLETT"  hasMips="true"   autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5"     format="R11FG11FB10F" />
    <RenderTarget id="SSR_REFL_1"       platforms="PC|PROSPERO|SCARLETT"  hasMips="true"   autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5"     format="R11FG11FB10F" />
    <RenderTarget id="SSR_RAD_RAW"      platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5"     format="R11FG11FB10F" />
    <RenderTarget id="SSR_RAD_FILTERED" platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5"     format="R11FG11FB10F" />
    <RenderTarget id="SSR_RESOLVE_0"    platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="1.0"     format="R11FG11FB10F" />
    <RenderTarget id="SSR_RESOLVE_1"    platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="1.0"     format="R11FG11FB10F" />
    <RenderTarget id="SSR_HISTORY"      platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="1.0"     format="R11FG11FB10F" />
    <RenderTarget id="SSR_FINAL"        platforms="PC|PROSPERO|SCARLETT"  hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="1.0"     format="R11FG11FB10F" />
      
    <RenderTarget id="LUT_MASK"                        depthBuf="false"  numColBufs="1"  format="RED8" bilinear="true" scale="1.0"  allowDcc="false" shareTarget0="HBAOBUF"  shareBuffer0="0" />

    <RenderTarget id="LUT_MASK_FINAL"                  depthBuf="false"  numColBufs="1"  format="RED8" bilinear="true" scale="1.0"  allowDcc="false" />

    <RenderTarget id="GTAO_FRAME_0"                    depthBuf="false"  numColBufs="1"  format="RED8" pointSampleColBuf0="true" scale="0.5" scale3="1.0" scaleGroup="AmbientOcclusion"  allowDcc="false" />
    <RenderTarget id="GTAO_FRAME_1"                    depthBuf="false"  numColBufs="1"  format="RED8" pointSampleColBuf0="true" scale="0.5" scale3="1.0" scaleGroup="AmbientOcclusion"  allowDcc="false" />
    <RenderTarget id="GTAO_HISTORY_0"                  depthBuf="false"  numColBufs="1"  format="RG8"  pointSampleColBuf0="true" scale="0.5" scale3="1.0" scaleGroup="AmbientOcclusion"  allowDcc="false" />
    <RenderTarget id="GTAO_HISTORY_1"                  depthBuf="false"  numColBufs="1"  format="RG8"  pointSampleColBuf0="true" scale="0.5" scale3="1.0" scaleGroup="AmbientOcclusion"  allowDcc="false" />

    <RenderTarget id="HBAOBUF"                         depthBuf="false"  numColBufs="1"  format="RED8" bilinear="true" scale="1.0"  allowDcc="false"  />    
    
    <RenderTarget id="LIGHTSHAFT"                      depthBuf="false"  numColBufs="1"  format="RED16F" scale="0.25" maxSamples="0" pointSampleColBuf0="true" shareTarget0="VOLUME" shareBuffer0="1"  />
    <RenderTarget id="BLUR1_REDONLY"                   depthBuf="false"  numColBufs="1"  format="RED16F" scale="0.5" maxSamples="0" pointSampleColBuf0="true"  allowDcc="false" />

    <RenderTarget id="VOLUME"      depthBuf="false" numColBufs="2"  format0="RGBA16F" format1="RED16F" scale="1.0" maxSamples="0" pointSampleColBuf0="true" pointSampleColBuf1="true"   />
    <RenderTarget id="BLUR1"       depthBuf="false"  numColBufs="1"  format="RGBA16F" scale="1.0" maxSamples="0" pointSampleColBuf0="true"  esramPageColBuf0="215" />

    <RenderTarget id="DEPTH"            depthBuf="true"   depthBufUsesBB="true"  numColBufs="0"  format="RGBA8" scale="1.0" maxSamples="0" stencilBuf="true"   esramPageDepthBuf="0" crossPipeShareId="DEPTH_SHARED" />
    <RenderTarget id="DEPTH_SSR"        depthBuf="true"   depthBufUsesBB="false" numColBufs="0"  format="RGBA8" scale="0.5" maxSamples="0" stencilBuf="true"   platforms="PC|PROSPERO|SCARLETT" />
    <RenderTarget id="DEPTH_DOWN"       depthBuf="false"  numColBufs="1"  format="RED32F"     scale="0.5" maxSamples="0" pointSampleColBuf0="true"  allowDcc="false"   esramPageColBuf0="488" crossPipeShareId="DEPTHD_SHARED" />
    <RenderTarget id="DEPTH_PART"       depthBuf="false"  numColBufs="1"  format="RED32F"     scale="0.5" maxSamples="0" pointSampleColBuf0="true"   />
    <RenderTarget id="DEPTH_LINEAR"     depthBuf="false"  numColBufs="1"  format="RED32F"     scale="1.0" maxSamples="0" pointSampleColBuf0="true"  esramPageColBuf0="124"  crossPipeShareId="DEPTH_LINEAR_SHARED" />
    <RenderTarget id="DEPTH_ASYNC"      depthBuf="false"  numColBufs="1"  format="RED32F"     scale="1.0" maxSamples="0" pointSampleColBuf0="true"   esramPageColBuf0="124"  />    
    <RenderTarget id="DEPTH_SSR_HI_Z"   depthBuf="false"  numColBufs="1"  format="RED16F"     scale="0.5" maxSamples="0" pointSampleColBuf0="true"  allowDcc="true"   hasMips="true" autoGenMips="false" mipsSRVs="true" platforms="PC|PROSPERO|SCARLETT" />
    <RenderTarget id="DEPTH_SSR_LOW_Z"  depthBuf="false"  numColBufs="1"  format="RED16F"     scale="0.5" maxSamples="0" pointSampleColBuf0="true"  allowDcc="true"   hasMips="true" autoGenMips="false" mipsSRVs="true" platforms="PC|PROSPERO|SCARLETT" />

    <!--<RenderTarget id="CLOUDS_DEPTH"     depthBuf="true"  numColBufs="1" format="RED8" bilinear="true" scale="0.5" />
    <RenderTarget id="CLOUDS_LOW"     depthBuf="false"  numColBufs="2" format0="RGBA8"  format1="RED32F" bilinear="true" scale="1.0" />
    <RenderTarget id="CLOUDS_MED"     depthBuf="false"  numColBufs="2" format0="RGBA8"  format1="RED32F" bilinear="true" scale="1.0" />-->
    <RenderTarget id="CLOUDS_HIGH"    depthBuf="false"  numColBufs="2" format0="RGBA8"  format1="RED32F" bilinear="true" scale="1.0"  allowDcc="false"  />
    <RenderTarget id="CLOUDSHADOWS"   depthBuf="false" numColBufs="1" format="RED8" bilinear="true" scale="0.25" allowDcc="false" />
    
    <RenderTarget id="CLOUD_BLURBUF1" depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.0" allowDcc="false" />
    <RenderTarget id="CLOUD_BLURBUF2" depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.0" allowDcc="false" />

	<RenderTarget id="WATER"     depthBuf="false"  numColBufs="2" format0="RGBA8"  format1="RED32F" bilinear="true" scale="1.0" />
	<RenderTarget id="PARTICLES"     depthBuf="false"  numColBufs="2" format0="RGBA8"  format1="RED32F" bilinear="true" scale="1.0" />
	<RenderTarget id="PARTICLES_DEPTH"     depthBuf="true"  numColBufs="2" format0="RGBA8"  format1="RED32F" bilinear="true" scale="1.0" />

    <RenderTarget id="LIGHTS_DUMMY_TARGET"      depthBuf="false" numColBufs="1" format="RED8" bilinear="false" scale="0.0625" />
    <RenderTarget id="LIGHTS_TILEBUF"     depthBuf="false" numColBufs="1" format="RED32I" bilinear="false" scaleX="0.5" scaleY="1.0" allowDcc="false" esramPageColBuf0="124" />
    
    <RenderTarget id="DOF_DOWNSAMPLE"     depthBuf="false" numColBufs="2" format0="R11FG11FB10F" format1="RED8" bilinear="true" scale="0.5" allowDcc="false" shareTarget0="BLOOM_BLURBUF_2A" shareBuffer0="0" />       
    <RenderTarget id="DOF_BLURBUF1"       depthBuf="false" numColBufs="2" format0="R11FG11FB10F" format1="RED8" bilinear="true" scale="0.5" allowDcc="false" shareTarget0="BLOOM_BLURBUF_2B" shareBuffer0="0" />

    <RenderTarget id="MOTION_MAXBUF_H"    platforms="ORBIS|XBOX" depthBuf="false" numColBufs="1" format="RGBA8"        bilinear="true" scaleX="0.125" scaleY="1.0" allowDcc="false" crossPipeShareId="MOTION_HORZ" />
    <RenderTarget id="MOTION_MAXBUF_0"    platforms="ORBIS|XBOX" depthBuf="false" numColBufs="1" format="RGBA8"        bilinear="true" scale="0.125"  allowDcc="false"  />
    <RenderTarget id="MOTION_MAXBUF_1"    platforms="ORBIS|XBOX" depthBuf="false" numColBufs="1" format="RGBA8"        bilinear="true" scale="0.125"  allowDcc="false"  />
    <RenderTarget id="MOTIONRESOLVE"      platforms="ORBIS|XBOX" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scale="1.0" maxSamples="0"   />
    <RenderTarget id="MOTION_FRONTBUF"    platforms="PC|PROSPERO|SCARLETT" depthBuf="false" numColBufs="1" format="RG16"           scale="1.0"    allowDcc="false" />
    <RenderTarget id="MOTION_MAXBUF_H"    platforms="PC|PROSPERO|SCARLETT" depthBuf="false" numColBufs="1" format="RGBA16"         scaleX="0.125" scaleY="1.0" allowDcc="false" />
    <RenderTarget id="MOTION_MAXBUF_0"    platforms="PC|PROSPERO|SCARLETT" depthBuf="false" numColBufs="1" format="RGBA16"         scale="0.125"  allowDcc="false"  />
    <RenderTarget id="MOTION_MAXBUF_1"    platforms="PC|PROSPERO|SCARLETT" depthBuf="false" numColBufs="1" format="RGBA16"         scale="0.125"  allowDcc="false"  />
    <RenderTarget id="MOTIONRESOLVE"      platforms="PC|PROSPERO|SCARLETT" depthBuf="false" numColBufs="1" format="RGBA16"         scale="1.0"    maxSamples="0"   />
    
    <RenderTarget id="MOTIONSCREEN"       platforms="PC"                   depthBuf="false" numColBufs="1" format="RG16F"          scale="1.0"    maxSamples="0"  /> 
    
    <RenderTarget id="DOF_MAXBUF_H"       depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scaleX="0.0625" scaleY="1.0"   allowDcc="false" />
    <RenderTarget id="DOF_MAXBUF"         depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.0625"   allowDcc="false" />

    <RenderTarget id="LENS_BLURBUF"       depthBuf="false" numColBufs="2" format0="R11FG11FB10F"  format1="R11FG11FB10F"  scale="0.25" allowDcc="false" shareTarget0="BLOOM_BLURBUF_4A" shareBuffer0="0" shareTarget1="BLOOM_BLURBUF_4B" shareBuffer1="0"/>
    <RenderTarget id="LENS_FLAREBUF"      depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25"      allowDcc="false" />
    <RenderTarget id="LENS_BRIGHTBUF"     depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"     allowDcc="false" shareTarget0="BLOOM_BLURBUF_8A" shareBuffer0="0" />
    <RenderTarget id="LENS_SUNBUF_A"      depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"     allowDcc="false" />
    <RenderTarget id="LENS_SUNBUF_B"      depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"     allowDcc="false" shareTarget0="BLOOM_BLURBUF_8B" shareBuffer0="0" />
    <RenderTarget id="LENS_ANARESBUF"     depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"     allowDcc="false" shareTarget0="BLOOM_BLURBUF_8B" shareBuffer0="0" />
    <RenderTarget id="LENS_ANABUF_A"      depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.0625"    allowDcc="false" />    
    <RenderTarget id="LENS_ANABUF_B"      depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.0625"    allowDcc="false" />
    
    <RenderTarget id="BLOOM_BLURBUF_2A"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.5"       allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_2B"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.5"       allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_4A"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25"      allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_4B"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25"      allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_8A"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"     allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_8B"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"     allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_16"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.0625"    allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_32"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.03125"   allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_64"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.015625"  allowDcc="false" />
    <RenderTarget id="BLOOM_FINALBUF"     depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25"      allowDcc="false" />
    
    <RenderTarget id="BLOOM_EXPBUF_A"     depthBuf="false" numColBufs="1" format="RED8"         bilinear="true" scale="1.0"       allowDcc="false" width="4" height="4" />
    <RenderTarget id="BLOOM_EXPBUF_B"     depthBuf="false" numColBufs="1" format="RED8"         bilinear="true" scale="1.0"       allowDcc="false" width="4" height="4" />

    <RenderTarget id="FINAL_OR_DOF_TONEMAP"    depthBuf="false" numColBufs="1" format="R11FG11FB10F" scale="1.0" maxSamples="0"   allowDcc="false" />

    <RenderTarget id="BACK_LENSFINAL_OR_UI_COMBINE_BUF"     depthBuf="false" numColBufs="1" format="R11FG11FB10F"  bilinear="true" scale="1.0"  allowDcc="false" />

    <RenderTarget id="LENSFINAL_OR_UI_COMBINE_BUF"     depthBuf="false" numColBufs="1" format="R11FG11FB10F"  bilinear="true" scale="1.0"  allowDcc="false" />
  </Setup>

  <!-- Scene rendering -->
  <CommandQueue>

    <Stage id="AttributesNG" enabled="false">
      <StartPrevFrameAsync />
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />

      <ColourMask channels="RGBA"/>
      <!-- Clear targets, colbuf1 is cleared separately to max depth -->
      <ClearTarget colBuf0="false"  colBuf1="false" colBuf2="false"  colBuf3="false" colBuf4="false" depthBuf="true"   stencilBuf="true" />
      <DiscardTargetContents colBuf0="true"  colBuf1="true" colBuf2="true"  colBuf3="true" colBuf4="true" />
      <ColourMask channels="RGBA"/>
      <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->

      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DrawGeometry type="Mesh"         class="Opaque"          context="DEPTHONLY_FRWRD"             order="STATECHANGES" />

      <!-- Z Pre-Pass for Cutout (grass etc) -->
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" />
      <DrawGeometry type="InstanceMesh" class="DoubleSided"    context="DEPTHONLY_DEFER_INSTANCE"    order="MESH" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" />
      <DrawGeometry type="InstanceMesh" class="Cutout"         context="DEPTHONLY_DEFER_INSTANCE"    order="MESH" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"  stencilRef="8" />
      <DrawGeometry type="Terrain"      class="LOD0"           context="DEPTHONLY_DEFER"             order="" />
      <DrawGeometry type="Terrain"      class="LOD1"           context="DEPTHONLY_DEFER"             order="" />
      <DrawGeometry type="Terrain"      class="LOD2"           context="DEPTHONLY_DEFER"             order="" />
      <!-- Opaques-->

      <ColourMask channels="RGBA"/>
      <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DrawGeometry type="Mesh"         class="Highlight"       context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="Cutout"          context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="OpaqueBeforeUI"  context="LIT_DEFER"             order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="65" />
      <DrawGeometry type="Mesh"         class="ScreenSpaceReflections"          context="LIT_DEFER"             order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DrawGeometry type="Mesh"         class="DoubleSided"             context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="HighlightDoubleSided"    context="LIT_DEFER"             order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="8" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DF_CACHE_FB"       order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_TESS_FB"           order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_CACHE"       order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_TESS"        order="FRONT_TO_BACK" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DrawGeometry type="InstanceMesh" class="Opaque"    context="LIT_DEFER_INSTANCE"    order="MESH" />

      <DrawGeometry type="Mesh"         class="Glow"      context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="InstanceMesh" class="Glow"      context="LIT_DEFER_INSTANCE"    order="MESH" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" stencilMode="disabled" />

      <SetShaderControl psWaveLimit="0" />

      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />

      <SetShaderControl psWaveLimit="7" />

      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="8"/>
      <SetShaderControl vsLateAllocMax="22" psWaveLimit="0" />

      <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER_STC_T_SPLIT_FADE"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER"          order="FRONT_TO_BACK" />

      <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="PLANET"    context="LIT_DEFER_LOW"         order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="ASTEROID"  context="LIT_DEFER_ASTEROID"    order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" stencilMode="disabled" />
      <DrawGeometry type="Mesh"         class="Opaque"          context="LIT_DEFER"             order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" stencilMode="disabled" />
      <DrawGeometry type="InstanceMesh" class="Cutout"      context="LIT_DEFER_ZE_INSTANCE" order="MESH" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="equal" stencilMode="disabled" />
      <DrawGeometry type="InstanceMesh" class="DoubleSided" context="LIT_DEFER_ZE_INSTANCE" order="MESH" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskReadWriteInvert" stencilRef="0" stencilMaskRead="9" stencilMaskWrite="8"/>
      <DrawGeometry type="Mesh"         class="AtmosphereNear" context="PLANET_NEAR"      order="STATECHANGES"  />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="8"/>
      <DrawGeometry type="Mesh"         class="Atmosphere"     context="PLANET"           order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" />
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="DEPTH_CLEAR"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="DEPTH_CLEAR"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunDecal"     context="DEPTH_CLEAR"             order="STATECHANGES"  />
      <!-- These aren't real decals, they are just meshes with 2 UV sets which is why they are still rendered here. -->

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="3"/>
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunDecal"     context="LIT_DEFER"             order="STATECHANGES"  />

      <UnbindBuffers />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="maskRead" depthTest="always" />
      <DoForwardLightLoop type="Mesh" class="Sky" context="CLEAR" order="BACK_TO_FRONT" />

      <EndTarget flushCB="true" flushDB="true" />
    </Stage>
    
    
    <Stage id="Attributes">
      <StartPrevFrameAsync />
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />

      <ColourMask channels="RGBA"/>
      <!-- Clear targets, colbuf1 is cleared separately to max depth -->
      <ClearTarget colBuf0="false"  colBuf1="false" colBuf2="false"  colBuf3="false" colBuf4="false" depthBuf="true"   stencilBuf="true" />
      <DiscardTargetContents colBuf0="true"  colBuf1="true" colBuf2="true"  colBuf3="true" colBuf4="true" />
      <ColourMask channels="RGBA"/> <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->

      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />      
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <!-- Z Pre-Pass for Cutout (grass etc) -->
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" stencilMode="disabled" />
      <DrawGeometry type="InstanceMesh" class="DoubleSided"    context="DEPTHONLY_DEFER_INSTANCE"    order="MESH" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="disabled" />
      <DrawGeometry type="InstanceMesh" class="Cutout"         context="DEPTHONLY_DEFER_INSTANCE"    order="MESH" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"  stencilRef="8" />
      <DrawGeometry type="Terrain"      class="LOD0"           context="DEPTHONLY_DEFER"             order="" />
      <DrawGeometry type="Terrain"      class="LOD1"           context="DEPTHONLY_DEFER"             order="" />
      <DrawGeometry type="Terrain"      class="LOD2"           context="DEPTHONLY_DEFER"             order="" />      
      <!-- Opaques-->

      <ColourMask channels="RGBA"/> <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DrawGeometry type="Mesh"         class="Opaque"          context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="Highlight"       context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="Cutout"          context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="OpaqueBeforeUI"  context="LIT_DEFER"             order="STATECHANGES" />
      <!--
      <DrawGeometry type="Mesh"         class="ReflectionProbe" context="LIT_DEFER"             order="STATECHANGES" />
      -->

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="65" />
      <DrawGeometry type="Mesh"         class="ScreenSpaceReflections"          context="LIT_DEFER"             order="STATECHANGES" />
 
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DrawGeometry type="Mesh"         class="DoubleSided"             context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="HighlightDoubleSided"    context="LIT_DEFER"             order="STATECHANGES" />
     
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="8" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DF_CACHE_FB"       order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_TESS_FB"           order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_CACHE"       order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_TESS"        order="FRONT_TO_BACK" />
        
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DrawGeometry type="InstanceMesh" class="Opaque"    context="LIT_DEFER_INSTANCE"    order="MESH" />
      
      <DrawGeometry type="Mesh"         class="Glow"      context="LIT_DEFER"             order="STATECHANGES" />    
      <DrawGeometry type="InstanceMesh" class="Glow"      context="LIT_DEFER_INSTANCE"    order="MESH" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" stencilMode="disabled" />

      <SetShaderControl psWaveLimit="0" />

      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />

      <SetShaderControl psWaveLimit="7" />

      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="8"/>
      <SetShaderControl vsLateAllocMax="22" psWaveLimit="0" />

      <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER_STC_T_SPLIT_FADE"    order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER"          order="FRONT_TO_BACK" />

      <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="PLANET"    context="LIT_DEFER_LOW"         order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="ASTEROID"  context="LIT_DEFER_ASTEROID"    order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" stencilMode="maskWrite"/>
      <DrawGeometry type="InstanceMesh" class="Cutout"      context="LIT_DEFER_ZE_INSTANCE" order="MESH" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="equal" stencilMode="maskWrite" />
      <DrawGeometry type="InstanceMesh" class="DoubleSided" context="LIT_DEFER_ZE_INSTANCE" order="MESH" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskReadWriteInvert" stencilRef="0" stencilMaskRead="9" stencilMaskWrite="8"/>
      <DrawGeometry type="Mesh"         class="AtmosphereNear" context="PLANET_NEAR"      order="STATECHANGES"  />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="8"/>
      <DrawGeometry type="Mesh"         class="Atmosphere"     context="PLANET"           order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" />
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="DEPTH_CLEAR"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="DEPTH_CLEAR"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunDecal"     context="DEPTH_CLEAR"             order="STATECHANGES"  />
      <!-- These aren't real decals, they are just meshes with 2 UV sets which is why they are still rendered here. -->

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="3"/>
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunDecal"     context="LIT_DEFER"             order="STATECHANGES"  />

      <UnbindBuffers />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="maskRead" depthTest="always" />
      <DoForwardLightLoop type="Mesh" class="Sky" context="CLEAR" order="BACK_TO_FRONT" />
      
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="CopyDepth">
      <!-- wait until compute is done with the depth_down buffer -->
      <SyncComputeToGraphics compute="async_next" markerIndex="2" />      
      <!-- wait until compute is done with the lightshafts buffer (which is using DEPTH_DOWN) -->
      <SyncComputeToGraphics compute="async_next" markerIndex="3" />
      <BeginTarget target="DEPTH_LINEAR" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
     </Stage>
    
     <Stage id="MOTIONRESOLVE">

      <!-- wait until compute is done with MOTIONRESOLVE -->

      <SyncComputeToGraphics compute="async_next" markerIndex="1" />

      <BeginTarget target="MOTIONRESOLVE"  depthTarget="DEPTH" readOnlyDepth="true"  />
      <DiscardTargetContents colBuf0="true" />
      
      <ColourMask channels="RGBA"/>
      
      <BindBuffer sampler="gBufferMap"  sourceRT="GBUFFER" bufIndex="1" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="GBUFFER" bufIndex="3" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskread" stencilMask="12" stencilRef="0"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONRESOLVE" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskread" stencilMask="8" stencilRef="8"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONRES_TERR" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskread" stencilMask="4" stencilRef="4"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONRES_CLIP" />
      
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="MotionDilate">
      <SyncGraphicsToCompute compute="async" />
      <BeginTarget target="MOTION_MAXBUF_H" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTIONRESOLVE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR"       bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONDILATE_HORZ" compute="async" />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="MOTION_MAXBUF_0" targetB="MOTION_MAXBUF_1" />

      <BeginTarget target="MOTION_MAXBUF_0" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTION_MAXBUF_H" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR"         bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONDILATE_VERT" compute="async" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="MotionFrontMost" enabled="false">
      <BeginTarget target="MOTION_FRONTBUF" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTIONRESOLVE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR"  bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTION_FRONT" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>        

    <Stage id="DepthDown">
      <BeginTarget target="DEPTH_DOWN" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"    bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />    
    </Stage>

    <Stage id="CloudsHigh">
      <BeginTarget target="CLOUDS_HIGH" />
      <ColourMask channels="RGBA"/>
      <!--<BindBuffer sampler="gDepthMap"      sourceRT="CLOUDS_DEPTH"    bufIndex="0" />-->
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/Cloud.material.mbin" uniform="gCloudParamsVec4" a="10.0" />
      <DrawQuad material="Materials/Cloud.material.mbin" context="RENDER_HIGH" width ="1.0" height="1.0" compute="async" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="CloudsBlur">
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <ColourMask channels="RGBA" />

      <BeginTarget target="CLOUD_BLURBUF2" />
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_HIGH" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_SIMPLE" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="CLOUD_BLURBUF1" />
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUD_BLURBUF2" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_SIMPLE" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="CloudsShadows">
      <BeginTarget target="CLOUDSHADOWS" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBuffer1Map"  sourceRT="DEPTH_DOWN"    bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="Materials/Cloud.material.mbin" context="RENDER2D" width ="1.0" height="1.0" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="Shadow_All_Clear">
      <BeginTarget target="SHADOWBUF" />
      <SetShadowMap index="-1" />
      <ColourMask channels="RGBA"/>
      <ClearTarget depthBuf="true" colBuf0="false" excludeX360="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>
    
    <Stage id="Decals">

      <BeginTarget target="GBUFFER" depthTarget="DEPTH" readOnlyDepth="true" />
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"    bufIndex="0"   />

      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="disabled"/>
      <DrawGeometry type="InstanceMesh" class="Decal"    context="LIT_DEFER_INSTANCE"    order="MESH" />
      <DrawGeometry type="Mesh"         class="Decal"    context="LIT_DEFER"             order="STATECHANGES" />      

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
    </Stage>

    <Stage id="Shadow_0_Clear" enabled="false">
      <BeginTarget target="SHADOWBUF" />
      <ColourMask channels="RGBA"/>
      <SetShadowMap index="0" />
      <ClearTarget depthBuf="true" colBuf0="false" excludeX360="false" depthViewportOnly="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
    </Stage>

    <Stage id="Shadow_0">
      
      <BeginTarget target="SHADOWBUF" />

      <UpdateShadowMap />

      <ColourMask channels="RGBA"/>
      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      
      <!--PS4: we're using HTile but not allowing compression, to save decompressing the very large shadowmap target at the end -->
      

      <SetShadowMap index="0" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="Glow"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI" context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Cutout"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Highlight"      context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"     context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"         context="SHADOW_INSTANCE_FADE"   order="MESH"/>
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"         context="SHADOW_INSTANCE_FADE"   order="MESH"/>
      <DrawShadowGeometry type="InstanceMesh" class="Glow"           context="SHADOW_INSTANCE_FADE"   order="MESH"/>

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="MESH"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="STATECHANGES"/>

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Shadow_1_Clear" enabled="false">
      <BeginTarget target="SHADOWBUF" />
      <ColourMask channels="RGBA"/>
      <SetShadowMap index="1" />
      <ClearTarget depthBuf="true" colBuf0="false" excludeX360="false" depthViewportOnly="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
    </Stage>

    <Stage id="Shadow_1">
      
      <BeginTarget target="SHADOWBUF" />

      <UpdateShadowMap />

      <ColourMask channels="RGBA"/>
      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      
      <!--PS4: we're using HTile but not allowing compression, to save decompressing the very large shadowmap target at the end -->
      

      <SetShadowMap index="1" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Mesh"         class="Glow"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"         context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI" context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Cutout"         context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Highlight"      context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"     context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"         context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"         context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="InstanceMesh" class="Glow"           context="SHADOW_INSTANCE_FADE"   order="MESH" />

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="STATECHANGES"/>

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Shadow_2_Clear" enabled="false">
      <BeginTarget target="SHADOWBUF" />
      <ColourMask channels="RGBA"/>
      <SetShadowMap index="2" />
      <ClearTarget depthBuf="true" colBuf0="false" excludeX360="false" depthViewportOnly="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
    </Stage>

    <Stage id="Shadow_2">
      
      <BeginTarget target="SHADOWBUF" />

      <UpdateShadowMap />

      <ColourMask channels="RGBA"/>
      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      
      <!--PS4: we're using HTile but not allowing compression, to save decompressing the very large shadowmap target at the end -->
      

      <SetShadowMap index="2" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2" />
      <DrawShadowGeometry type="Mesh"         class="Glow"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"         context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI" context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Cutout"         context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Highlight"      context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"     context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"         context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"         context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="InstanceMesh" class="Glow"           context="SHADOW_INSTANCE_FADE"   order="MESH" />

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2"  />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2" />      
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="STATECHANGES"/>

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Shadow_End">
      <BeginTarget target="SHADOWBUF" />
      <SetShadowMap index="-1" />

      <SetDepthBufferControl allowCompression="true" />    
      <EndTarget flushCB="false" flushDB="true" />
    </Stage>
         
    <Stage id="SkyScratchPad" enabled="false" >
      <SyncComputeToGraphics compute="async_next" />

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGB" />      

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="2"   />
      <DoForwardLightLoop type="Mesh" class="Sky" context="SCRATCHPAD" order="BACK_TO_FRONT" />

      <EndTarget flushCB="true" flushDB="false" />
      
      <UnbindBuffers />

    </Stage>
    
    <Stage id="Sky">

      <SyncComputeToGraphics compute="async_next" />

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />

      <!-- Space/Night Sky -->      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="2"   />
      <DoForwardLightLoop type="Mesh" class="Sky" context="LIGHTING" order="BACK_TO_FRONT" />
      <UnbindBuffers />

      <!-- Starfield -->
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" />
      <DrawGeometry type="PStream" class="Opaque"    context="PSTREAM_SYSTEM"    order="STATECHANGES" />

      <EndTarget flushCB="true" flushDB="false" />

    </Stage>
    
      
    <Stage id="HBAO" enabled="false">
    </Stage>

    <Stage id="HBAO_LITE" enabled="false">
    </Stage>

    <Stage id="GTAOGen_Low" enabled="false">
      <BeginTarget target="GTAO_FRAME_0" />
        <ColourMask channels="R"/>
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
        <BindBuffer sampler="gBuffer2Map" sourceRT="GBUFFER" bufIndex="2" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="disabled" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="GTAO_GEN_LOW" />
        <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="GTAOGen_Medium" enabled="false">
      <BeginTarget target="GTAO_FRAME_0" />
        <ColourMask channels="R"/>
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
        <BindBuffer sampler="gBuffer2Map" sourceRT="GBUFFER" bufIndex="2" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="disabled" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="GTAO_GEN_MEDIUM" />
        <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="GTAOGen_High" enabled="false">  
      <BeginTarget target="GTAO_FRAME_0" />
        <ColourMask channels="R"/>
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
        <BindBuffer sampler="gBuffer2Map" sourceRT="GBUFFER" bufIndex="2" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="disabled" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="GTAO_GEN_HIGH" />
        <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="GTAOFin" enabled="false">

      <BeginTarget target="GTAO_FRAME_1" />
        <ColourMask channels="R" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="GTAO_FRAME_0" bufIndex="0" />
        <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_LINEAR" bufIndex="0"  />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="disabled" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="GTAO_SPATIAL_H_DENOISE" />
        <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="GTAO_FRAME_0" />
        <ColourMask channels="R" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="GTAO_FRAME_1" bufIndex="0" />
        <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_LINEAR" bufIndex="0"  />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="disabled" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="GTAO_SPATIAL_V_DENOISE" />
        <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
           
      <BeginTarget target="GTAO_HISTORY_0" />
        <ColourMask channels="RG" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="GTAO_HISTORY_1" bufIndex="0" />
        <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH"          bufIndex="32"/>
        <BindBuffer sampler="gBuffer3Map" sourceRT="GTAO_FRAME_0"   bufIndex="0" />
        <BindBuffer sampler="gBuffer4Map" sourceRT="MOTIONRESOLVE"  bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="disabled" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="GTAO_TEMPORAL_FILTER" />
        <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="GTAOCopy" enabled="false">
      <BeginTarget target="HBAOBUF" />
        <ColourMask channels="R" />
        <BindBuffer sampler="gBufferMap" sourceRT="GTAO_HISTORY_0" bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="disabled" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="BILATERAL_SIMPLE_REDONLY_UPSAMPLE" />
        <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="GTAO_HISTORY_0" targetB="GTAO_HISTORY_1" />
    </Stage>  
    
    <Stage id="GTAOCopyUltra" enabled="false">
      <BeginTarget target="HBAOBUF" />
        <ColourMask channels="R" />
        <BindBuffer sampler="gBufferMap" sourceRT="GTAO_HISTORY_0" bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="disabled" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="COPY" />
        <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="GTAO_HISTORY_0" targetB="GTAO_HISTORY_1" />
    </Stage>  

    <Stage id="NO_HBAO" enabled="false">
      <BeginTarget target="HBAOBUF" />
      
      <ColourMask channels="R"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <ClearTarget colBuf0="true"   colBuf1="false" colBuf2="false"  colBuf3="false" colBuf4="false" depthBuf="false"   stencilBuf="false" col_R="1.0" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="LensSun">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskReadInvert"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PARTICLE_CLEAR" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SyncComputeToGraphics compute="async" />
      <BeginTarget target="LENS_SUNBUF_A" />
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap"   sourceRT="HDRBUF_0"       bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="CLOUD_BLURBUF1" bufIndex="0" />
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="BRIGHT_SUN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_SUNBUF_B" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_SUNBUF_A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="2.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_SUNBUF_A" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_SUNBUF_B" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="LENS_SUNBUF_B" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_SUNBUF_A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="2.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_SUNBUF_A" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_SUNBUF_B" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
          
    <Stage id="Sunlight">      
      <BeginTarget target="SUNOUT_0" depthTarget="DEPTH" />

      <ColourMask channels="RGB"  />
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="DEPTH_LINEAR"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="GBUFFER"    bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="3"  />
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gBuffer4Map"  sourceRT="HBAOBUF"    bufIndex="0" addressMode="clamp" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskReadInvert" stencilMask="9" stencilRef="0"/>
      <DrawQuadMT material="materials/Light.material.mbin" context="SUNLIGHT_SPLIT" />
      <!-- <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskread" stencilMask="8" stencilRef="8"/>
      <DrawQuadMT material="materials/Light.material.mbin" context="SUNLIGHT_TERRAIN" /> -->

      <SetContext stencilMode="disabled" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>
    <Stage id="ShadowApply" >

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />

      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false"  />
      <BindBuffer sampler="gBufferMap"   sourceRT="SUNOUT_0"    bufIndex="1"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="DEPTH_LINEAR"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="GBUFFER"    bufIndex="3"  />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer4Map"  sourceRT="HBAOBUF"    bufIndex="0" addressMode="clamp" />
      <BindBuffer sampler="gBuffer5Map"  sourceRT="GBUFFER"    bufIndex="1"  />  <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />


      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="always" stencilMode="maskReadInvert" stencilMask="9" stencilRef="0"/>
      <DrawQuadMT material="materials/Light.material.mbin" context="SHADOW_APPLY"/>

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="true" />
    </Stage>

    <Stage id="SpotlightsTiled" enabled="false">

      <BeginTarget target="LIGHTS_TILEBUF" />
      <ColourMask channels="RGBA"/>
      <ClearTarget depthBuf="false" colBuf0="true" col_R="0.0" col_G="0.0" col_B="0.0" />
      <EndTarget flushCB="true" flushDB="false" flushForCompute="true" />

      <BeginTarget target="LIGHTS_DUMMY_TARGET" />

      <BindBuffer sampler="gOutTexture0" sourceRT="LIGHTS_TILEBUF" bufIndex="0" bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="replace"    stencilMode="disabled" depthTest="always" />
      <DoDeferredLightLoop context="SPOT_INNER_LIST" inner="true"/> 

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace"    stencilMode="disabled" depthTest="always" />
      <DoDeferredLightLoop context="SPOT_OUTER_LIST" inner="false"/> 
      
      <UnbindBuffers />      
      <EndTarget flushCB="true" flushDB="false" />

      <SyncGraphicsToCompute compute="async" />
      <BeginTarget target="SHADOWBUF_DS" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SHADOWBUF" bufIndex="32" shadowCompare="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_DEPTH" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="true" />

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />

      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false" />
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="DEPTH_LINEAR"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="GBUFFER"    bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="3"  />
      <BindBuffer sampler="gBuffer4Map"  sourceRT="HBAOBUF"    bufIndex="0" addressMode="clamp" />
      <BindBuffer sampler="gBuffer5Map"  sourceRT="SUNOUT_0"   bufIndex="1"  />
      <BindBuffer sampler="gOutTexture0" sourceRT="LIGHTS_TILEBUF" bufIndex="0" bindAsRwImage="true" />
      
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"    stencilMode="disabled" depthTest="always" />
      <DoDeferredLightLoopMulti context="SPOT_MULTI" inner="true"/>

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Spotlights">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />

      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false" />
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="DEPTH_LINEAR"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="GBUFFER"    bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="3"  />
      <BindBuffer sampler="gBuffer4Map"  sourceRT="HBAOBUF"    bufIndex="0" addressMode="clamp" />
      
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add"    stencilMode="maskReadInvert" depthTest="greaterEqual" />
      <DoDeferredLightLoop context="SPOTLIGHT_INNER" inner="true"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add"    stencilMode="maskReadInvert" depthTest="less" />
      <DoDeferredLightLoop context="SPOTLIGHT_OUTER" inner="false"/>


      <SetContext stencilMode="disabled" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="TileVisualise" enabled="false">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />

      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="DEPTH_LINEAR"    bufIndex="0"  />

      <BindBuffer sampler="gOutTexture0" sourceRT="LIGHTS_TILEBUF" bufIndex="0" bindAsRwImage="true" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"    stencilMode="maskReadInvert" depthTest="always" />
      <DoDeferredLightLoopMulti context="SPOT_TILE_VIS" inner="true"/>

      <SetContext stencilMode="disabled" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <!--<Stage id="WaterFromAbove" >

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA"/>

      --><!-- Water --><!--
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="DEPTH_LINEAR"    bufIndex="0"  />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
      <DrawQuadMT material="Models/Planets/Terrain/Water.material.mbin" context="FULLSCREEN"/>

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />

    </Stage>-->
    
    <Stage id="WaterFromAbove"  >   
      <BeginTarget target="WATER" depthTarget="PARTICLES_DEPTH"/>
      <ColourMask channels="RGBA"/>
      <ClearTarget depthBuf="true" colBuf0="true" excludeX360="true" col_R="0.0" col_G="0.0" col_B="0.0" />
      
      <!-- Water -->
      <BindBuffer sampler="gBuffer1Map"   sourceRT="DEPTH_DOWN"    bufIndex="0"  />
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <DrawQuadMT material="Models/Planets/Terrain/Water.material.mbin" context="FULLSCREEN"/>

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
      
      <BeginTarget target="DEPTH_LINEAR" depthTarget="DEPTH" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
      <BindBuffer sampler="gBufferMap"  sourceRT="PARTICLES_DEPTH" bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN_LESS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />

      <BeginTarget target="DEPTH_DOWN" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"    bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGB" />
           
      <BindBuffer sampler="gBufferMap"  sourceRT="WATER" bufIndex="0" />
      <SetContext zwrite="false" blendMode="blend" colourWrite="true" depthTest="always" stencilMode="maskread" stencilRef="4"  stencilMask="4" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_SRGB_TO_P3"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>
    
    <Stage id="SSR_HighZMips" enabled="false">
      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="0" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z" />
      <EndTarget flushCB="true" flushDB="false" />

      <!--
      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="0" />      
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="COPY" />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="0" />      
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_LINNORM2REV" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      -->
      
      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="1" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_HI_Z" bufIndex="0" mipLevel="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="2" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_HI_Z" bufIndex="0" mipLevel="1" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="1"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="3" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_HI_Z" bufIndex="0" mipLevel="2" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="2"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="4" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_HI_Z" bufIndex="0" mipLevel="3" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="3"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="5" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_HI_Z" bufIndex="0" mipLevel="4" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="4"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="6" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_HI_Z" bufIndex="0" mipLevel="5" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="5"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <!--
      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="7" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_HI_Z" bufIndex="0" mipLevel="6" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="6"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_HI_Z" mipLevel="8" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_HI_Z" bufIndex="0" mipLevel="7" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="6"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      -->

      <BeginTarget target="DEPTH_SSR_LOW_Z" mipLevel="0" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_HI_Z" bufIndex="0" mipLevel="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="DEPTH_SSR_LOW_Z" mipLevel="1" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_LOW_Z" bufIndex="0" mipLevel="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="LOW_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_LOW_Z" mipLevel="2" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_LOW_Z" bufIndex="0" mipLevel="1" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="1"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="LOW_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_LOW_Z" mipLevel="3" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_LOW_Z" bufIndex="0" mipLevel="2" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="2"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="LOW_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_LOW_Z" mipLevel="4" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_LOW_Z" bufIndex="0" mipLevel="3" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="3"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="LOW_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_LOW_Z" mipLevel="5" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_LOW_Z" bufIndex="0" mipLevel="4" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="4"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="LOW_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_LOW_Z" mipLevel="6" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_LOW_Z" bufIndex="0" mipLevel="5" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="5"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="LOW_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <!--
      <BeginTarget target="DEPTH_SSR_LOW_Z" mipLevel="7" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_LOW_Z" bufIndex="0" mipLevel="6" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="5"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="LOW_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_SSR_LOW_Z" mipLevel="8" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_SSR_LOW_Z" bufIndex="0" mipLevel="7" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="5"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="LOW_Z"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      -->
    </Stage>
    
    <Stage id="SSR_March" enabled="false">      
      <BeginTarget target="SSR_TRACE" depthTarget="DEPTH_SSR" />
      <ColourMask channels="RGBA"/>
      <ClearTarget colBuf0="true"  colBuf1="true" colBuf2="true"  colBuf3="false" colBuf4="false" depthBuf="false" stencilBuf="true" />            
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH_SSR_HI_Z"     bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="DEPTH_SSR_LOW_Z"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="GBUFFER_BIL"        bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="GBUFFER_BIL"        bufIndex="3"  />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskWrite" stencilRef="64" stencilMask="64"/>
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_MARCH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="SSR_ColourMips" enabled="false">
      <!-- blur into mips -->
      <ColourMask channels="RGB"  />
      <BeginTarget target="SSR_REFL_1" mipLevel="1"/>                
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="3.0" d="0"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="SSR_REFL_0" mipLevel="1"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" d="1"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
          
      <BeginTarget target="SSR_REFL_1" mipLevel="2"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="3.0" d="1"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
          
      <BeginTarget target="SSR_REFL_0" mipLevel="2"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" d="2"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_REFL_1" mipLevel="3"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="3.0" d="2"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_REFL_0" mipLevel="3"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" d="3"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_REFL_1" mipLevel="4"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="3.0" d="3"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_REFL_0" mipLevel="4"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" d="4"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_REFL_1" mipLevel="5"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="3.0" d="4"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_REFL_0" mipLevel="5"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" d="5"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF"   wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>    

    <Stage id="SSR_Radiance" enabled="false">
      <BeginTarget target="SSR_RAD_RAW" depthTarget="DEPTH_SSR" />
      <ColourMask channels="RGBA"/>
      <ClearTarget colBuf0="true" />
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH_SSR_HI_Z"     bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="MOTION_FRONTBUF"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="GBUFFER_BIL"        bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="GBUFFER_BIL"        bufIndex="3"  />
      <BindBuffer sampler="gBuffer4Map"   sourceRT="SSR_UVS"            bufIndex="0"  />
      <BindBuffer sampler="gBuffer5Map"   sourceRT="SSR_PDF"            bufIndex="0"  />
      <BindBuffer sampler="gBuffer6Map"   sourceRT="SSR_VISIBILITY"     bufIndex="0"  />
      <BindBuffer sampler="gBuffer7Map"   sourceRT="SSR_REFL_0"         bufIndex="0"  />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64"/>
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_RADIANCE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_RAD_FILTERED" depthTarget="DEPTH_SSR" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_RAD_RAW"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_MEDIAN" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="SSR_Resolve" enabled="false">
      <BeginTarget target="SSR_RESOLVE_0" depthTarget="DEPTH" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"    sourceRT="SSR_RAD_FILTERED" bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="SSR_PDF"          bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="GBUFFER_BIL"      bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="GBUFFER_BIL"      bufIndex="3"  />      

      <SetContext zwrite="false" colourWrite="true"  cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead"      stencilRef="64"   stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_RESOLVE" />
      <UnbindBuffers />            
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
            
    <Stage id="SSR_Temporal" enabled="false">
      <BeginTarget target="SSR_FINAL" depthTarget="DEPTH" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_RESOLVE_0"    bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="SSR_HISTORY"      bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTION_FRONTBUF"  bufIndex="0" />
            
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_TEMPORAL" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      
    </Stage>
    
    <Stage id="SSR_CopyTo" enabled="false">
      <!-- Copy it back into the scene -->
      
      <ColourMask channels="RGB" />
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <BindBuffer sampler="gBufferMap"      sourceRT="SSR_FINAL"    bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="COPY_ADD"  />          
      <SetContext stencilMode="disabled" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="SSR_FINAL" targetB="SSR_HISTORY" />
    </Stage>

    <Stage id="Shadow_DS">
      <BeginTarget target="SHADOWBUF_DS" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SHADOWBUF" bufIndex="32" shadowCompare="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="true" />
    </Stage>
    
    <Stage id="Volumetrics">

      <BeginTarget target="VOLUME" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <ClearTarget depthBuf="false" colBuf0="true" colBuf1="true" excludeX360="true" col_R="0.0" col_G="0.0" col_B="0.0" />

      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_DOWN" bufIndex="0" />
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF_DS"  bufIndex="32" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" stencilMode="disabled" depthTest="always" blendMode="add" />
      <DoForwardLightLoop type="Mesh" class="AtmosphereNear" context="SCATTER_MASK" order="FRONT_TO_BACK" />
      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="false" />

      <SyncComputeToGraphics compute="async" />
      <BeginTarget target="VOLUME" />

      <ColourMask channels="RGBA"/>

      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_DOWN" bufIndex="0" />
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF_DS"  bufIndex="32" />

      <SetContext zwrite="false" colourWrite="true" stencilMode="disabled" depthTest="always" blendMode="add" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLUR1" />
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME" bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="VOLUME" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLUR1"   bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_V_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="PlanetCloud">
      
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />
      
       <!--Cloud sphere around planets--> 
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="CLOUDSHADOW" order="BACK_TO_FRONT" />
    
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="CLOUD" order="BACK_TO_FRONT" />
    
      <EndTarget flushCB="false" flushDB="false" />
      
    </Stage>
          
    <Stage id="VolumetricsUPS">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />
           
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_LINEAR"  bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.25" /> 
      <SetContext zwrite="false" blendMode="blend" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BILATERAL_BLEND_UPSAMPLE"  />
      <UnbindBuffers />
      
      <!-- done with depth_down buffer -->
      <SyncGraphicsToCompute compute="async_next" markerIndex="2" />

      <EndTarget flushCB="false" flushDB="false" />    

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
 
       <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" stencilMode="disabled" depthTest="lessEqual" blendMode="add" />
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"  bufIndex="0" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="SCATTERING" order="FRONT_TO_BACK" />
      <UnbindBuffers />
            
      
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="blend" depthTest="always" /> <!--stencilMode="maskwriteonce" stencilRef="4"  stencilMask="4" />-->
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"  bufIndex="0" />
      <DoForwardLightLoop type="Mesh"    class="Rings"            context="RINGS" order="BACK_TO_FRONT" />
      <UnbindBuffers />
           
      <SetContext cullMode="back"/>
      <EndTarget flushCB="false" flushDB="false" />    

    </Stage>

    <Stage id="BlackHole">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh"     class="BlackHoleBack"       context="LIT_FORWARD"    order="STATECHANGES" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />

    </Stage>

    <Stage id="CloudsCopy">     
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" />
      <BindBuffer sampler="gBufferMap"     sourceRT="CLOUD_BLURBUF1"     bufIndex="0" />
      <BindBuffer sampler="gCloudDepthMap" sourceRT="CLOUDS_HIGH"     bufIndex="1" />
      <BindBuffer sampler="gDepthMap"      sourceRT="DEPTH_LINEAR"    bufIndex="0" />
      <DrawQuadMT material="materials/Cloud.material.mbin" context="COPY" width ="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="WaterFromBelow">

      <BeginTarget target="WATER" depthTarget="PARTICLES_DEPTH"/>
      <ColourMask channels="RGBA"/>
      <ClearTarget depthBuf="true" colBuf0="true" excludeX360="true" col_R="0.0" col_G="0.0" col_B="0.0" />

      <!-- Water -->
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="DEPTH_DOWN"    bufIndex="0"  />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" />
      <DrawQuadMT material="Models/Planets/Terrain/Water.material.mbin" context="FULLSCREEN_BELOW"/>

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />

      <BeginTarget target="DEPTH_LINEAR" depthTarget="DEPTH" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
      <BindBuffer sampler="gBufferMap"  sourceRT="PARTICLES_DEPTH" bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN_LESS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />

      <BeginTarget target="DEPTH_DOWN" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"    bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH"/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />

      <BindBuffer sampler="gBufferMap"  sourceRT="WATER"     bufIndex="0" />
      <SetContext zwrite="false" blendMode="blend" colourWrite="true" depthTest="always" stencilMode="maskread" stencilRef="4"  stencilMask="4" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="LENS_SUNBUF_A" />
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" stencilMode="disabled" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PARTICLE_CLEAR"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />    
    </Stage>

    <Stage id="TerrainEdits" enabled="false">

        <BeginTarget target="BLENDED_ABOVE" depthTarget="DEPTH"/>

        <ColourMask channels="RGBA" colBuf1="false" />

        <!-- Terrain Edits -->
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
        <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS"        order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_CACHE_FB"   order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_TESS_FB"   order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_CACHE"   order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_TESS"   order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="EDITS"        order="FRONT_TO_BACK" />

        <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="BlendedAbove">
      
      <BeginTarget target="BLENDED_ABOVE" depthTarget="DEPTH"/>

      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <!-- Quads -->
      <SetContext zwrite="true" colourWrite="true" cullMode="front"  blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
      <DoForwardLightLoop type="QUAD"     class="Opaque"  context="LIGHTING"  order="STATECHANGES" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="QUAD"     class="Opaque"  context="LIGHTING"  order="STATECHANGES" />

      <!-- Lines -->
      <ColourMask channels="RGB" colBuf1="false" />
      <!--a = alpha offset, b = noise threshold, c = is underground, d = alpha noise factor-->
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="add" depthTest="always" stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="LINE"     class="Opaque"  context="SUBSTANCES"  order="STATECHANGES" />
      
      <ColourMask channels="RGB" colBuf1="false" />
      <!-- player gun additive. has to be rendered before the laser so it can lay down the stencil.-->      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="7" stencilMask="7" />
      <DrawGeometry type="Mesh"         class="GunAdditive"    context="LIT_FORWARD"             order="STATECHANGES" />
      
      <!-- Transparent Objects -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="Additive"    context="LIT_FORWARD" order="BACK_TO_FRONT" />

      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="Translucent" context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="Mesh"     class="WarpInShip"  context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="Mesh"     class="Rainbow"     context="RAINBOW"     order="BACK_TO_FRONT" />

      <!-- PlaneSpotlight Object -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="PlaneSpot"    context="PLANESPOT" order="BACK_TO_FRONT" />
      
      <!--<ClearTarget colBuf0="false" depthBuf="false" stencilBuf="true" />-->      
      <ColourMask channels="RGB" colBuf1="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="Highlight"            context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightDoubleSided" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"   stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightTrans"            context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightTransDoubleSided" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <!-- Trails -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Trail" class="Translucent" context="LIGHTING" order="STATECHANGES" />

      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"   depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Trail" class="Additive"    context="LIGHTING" order="STATECHANGES" />

      <!--Single Lines-->
      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4" /> 
      <DoForwardLightLoop type="SingleLine" class="Opaque" context="LIGHTING" order="STATECHANGES" />

      <!--Single Lines-->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
      <DoForwardLightLoop type="SingleLine" class="Additive" context="LIGHTING" order="STATECHANGES" />

      <!-- Markers -->
      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="Map" context="SCREEN_MAP" order="BACK_TO_FRONT" />

      <!-- Glow Translucent RGB -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
      <DoForwardLightLoop type="Mesh"  class="GlowTranslucent" context="LIT_FORWARD" order="BACK_TO_FRONT" />
      
      <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="4"  stencilMask="7" />

      <!-- render the player laser stencil-only, to mask it in the TAA -->
      <!-- results in some overzealous clipping in AA but should be hard to see, the gun moves a lot -->
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaser" context="LIGHTING" order="STATECHANGES" />      
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaserCore" context="LIGHTING" order="STATECHANGES" />

      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskReadInvert" stencilRef="3" stencilMask="7" />

      <!-- player laser. actual colour rendering masked by the gun -->
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaser" context="LIGHTING" order="STATECHANGES" />      
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaserCore" context="LIGHTING" order="STATECHANGES" />        
        
      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="WarpOnFoot" context="LIT_FORWARD" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="invSourceAlpha" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"         class="UIScreen"         context="LIT_FORWARD"            order="BACK_TO_FRONT" />
      
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />

      <!-- Glow Translucent Alpha -->
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />    
      <ColourMask channels="A" colBuf1="false" colBuf2="false" colBuf3="false" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_OutputAlpha" depthTest="less" />
      <DoForwardLightLoop type="Mesh"  class="GlowTranslucent" context="LIT_FORWARD"    order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="Trail" class="Translucent"     context="LIGHTING_GLOW"  order="STATECHANGES"  />
      <DoForwardLightLoop type="Trail" class="Additive"        context="LIGHTING_GLOW"  order="BACK_TO_FRONT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>
      
    <Stage id="3dLines">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <ColourMask channels="RGBA"  />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" />
      <DrawGeometry type="LINERENDERER"  class="Opaque"   context="LINE3D"            order="STATECHANGES" />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>
    
    <Stage id="LUTMaskClear" enabled="false" >
      <BeginTarget target="LUT_MASK" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />      
      <ColourMask channels="R" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskReadInvert" stencilRef="32" stencilMask="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PARTICLE_CLEAR" />            
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="LightShafts" enabled="false">

      <BeginTarget target="LIGHTSHAFT" />
      <ColourMask channels="R"/>
      
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_DOWN" bufIndex="0" />    
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF_DS"  bufIndex="32" />

      <SetContext zwrite="false" colourWrite="true" stencilMode="disabled" depthTest="always" blendMode="replace" />
      <DrawQuadMT material="materials/Light.material.mbin" context="RAYMARCH" />
      
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="LightShaftsBlur" enabled="false">      
      <BeginTarget target="BLUR1_REDONLY" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="LIGHTSHAFT"      bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"  bufIndex="0"   />    
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_REDONLY_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="LIGHTSHAFT" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLUR1_REDONLY" bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_V_REDONLY_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="HDRBUF_0" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"  sourceRT="LIGHTSHAFT"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_LINEAR"       bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="HDRBUF_0"      bufIndex="0" />  <!-- APPEARS UNUSED -->
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.25" /> 
      <SetContext zwrite="false" blendMode="add" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="SCREEN_BILATERAL_UP" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <!--
    <Stage id="BloomCopy" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF1" />
      <DiscardTargetContents colBuf0="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <ColourMask channels="RGBA"/>      
      <BindBuffer sampler="gBufferMap"  sourceRT="GBUFFER" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="BRIGHTPASS_COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <SyncComputeToGraphics compute="async_next" />
    </Stage>
    -->  

   <Stage id="TAA_NONE" enabled="false">
      <SwapTargets targetA="HDRBUF_0" targetB="HDRBUF_1" />
    </Stage> 

   <Stage id="TAA_APPLY" enabled="false">
      <BeginTarget target="TAA_FRONT" />
      <DiscardTargetContents colBuf0="true" colBuf1="true" colBuf2="true" />
      <ColourMask channels="RGBA"/>
      
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0"        bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="TAA_BACK"        bufIndex="1" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"   bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR"    bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="MOTION_MAXBUF_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map" sourceRT="TAA_BACK"        bufIndex="2" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="STAA_APPLY" />

      <EndTarget flushCB="true" flushDB="false" />   


      <SwapTargets targetA="TAA_BACK" targetB="TAA_FRONT" />
      <SwapTargets targetA="BACK_LENSFINAL_OR_UI_COMBINE_BUF" targetB="LENSFINAL_OR_UI_COMBINE_BUF" />
    </Stage> 

   <Stage id="TAA_APPLY_CLIP" enabled="false">
      <BeginTarget target="TAA_FRONT" />
      <DiscardTargetContents colBuf0="true" colBuf1="true" colBuf2="true" />
      <ColourMask channels="RGBA"/>

      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="TAA_BACK"         bufIndex="1" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR"     bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map" sourceRT="TAA_BACK"         bufIndex="2" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="STAA_LOW" />
      <EndTarget flushCB="true" flushDB="false" />   

      <SwapTargets targetA="TAA_BACK" targetB="TAA_FRONT" />
      <SwapTargets targetA="BACK_LENSFINAL_OR_UI_COMBINE_BUF" targetB="LENSFINAL_OR_UI_COMBINE_BUF" />
    </Stage> 

   <Stage id="TAA_APPLY_TEST" enabled="false">
      <BeginTarget target="TAA_FRONT" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="TAA_BACK"         bufIndex="1" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR"     bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map" sourceRT="TAA_BACK"         bufIndex="2" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="STAA_APPLY_TEST" />
      <EndTarget flushCB="true" flushDB="false" />   


      <SwapTargets targetA="TAA_BACK" targetB="TAA_FRONT" />
      <SwapTargets targetA="BACK_LENSFINAL_OR_UI_COMBINE_BUF" targetB="LENSFINAL_OR_UI_COMBINE_BUF" />
    </Stage>
  
    <Stage id="Particles">

      <!-- Depth Downsample for particles - note we can't use the current down-sample, since Water may have written to the real Depth Buffer -->

      <BeginTarget target="DEPTH_PART" depthTarget="PARTICLES_DEPTH" />
      
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH"    bufIndex="32"   />
      <SetContext zwrite="true" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="PARTICLES" depthTarget="PARTICLES_DEPTH" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PARTICLE_CLEAR" />

      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_PART" bufIndex="0" />
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" />

      <DoForwardLightLoop  type="EMITTER"  class="Translucent" context="TRANSLUCENT_SOFT" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="Translucent" context="HEAVYAIR_SOFT" order="BACK_TO_FRONT"/>
      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="HDRBUF_1"  depthTarget="DEPTH"/>
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" />

      <BindBuffer sampler="gBuffer1Map" sourceRT="PARTICLES"    bufIndex="0" />
      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_PART"        bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PARTICLE_BLEND" />
      <UnbindBuffers />

      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_PART" bufIndex="0" />
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" />
      <DoForwardLightLoop  type="EMITTER"  class="Additive" context="TRANSLUCENT_ADDITIVE" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="Additive" context="HEAVYAIR_SOFT" order="BACK_TO_FRONT"/>

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />

    </Stage>

    <Stage id="SpeedLines">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="Blend_OutputOneMinusAlpha" depthTest="less" />
      <DoForwardLightLoop type="SPEEDLINE" class="Opaque" context="LIGHTING" order="STATECHANGES" />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="CopyDepth2">

      <!-- async is done with DEPTH_ASYNC -->
      <SyncGraphicsToCompute compute="async_next" markerIndex="3" />

      <BeginTarget target="DEPTH_ASYNC" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>

    <Stage id="NewBloomBright" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2A" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="HDRBUF_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="GBUFFER"  bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="BRIGHTPASS_NEW" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="SpotlightVolumetric" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2A" />
      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false" />
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"  bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="GBUFFER"       bufIndex="2"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add" stencilMode="disabled" depthTest="always" />      
      <DoDeferredLightLoop context="SPOTLIGHT_VOLUME" volumetric="true" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="NewBloomPre" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF" compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_2A" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2B" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF" compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_4B" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_2A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9" compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="MotionblurNormal" enabled="false">
      <BeginTarget target="VOLUME" />
      <DiscardTargetContents colBuf0="true"  />
      <ColourMask channels="RGBA" colBuf1="false" />

      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="disabled" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_LOW" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="BLUR1" />
      <DiscardTargetContents colBuf0="true"  />
      <ColourMask channels="RGBA"/>
      
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"           bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="disabled" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_LOW_PASS2" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="HDRBUF_1" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLUR1" bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" alphaToCoverage="false" stencilMode="disabled" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />   
    </Stage> 

    <Stage id="Motionblur" enabled="false">
      <BeginTarget target="LENSFINAL_OR_UI_COMBINE_BUF" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1"          bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_HIGH"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="LENSFINAL_OR_UI_COMBINE_BUF" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_HIGH_PASS2" compute="async_next"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />   
    </Stage> 

    <Stage id="MotionblurUltra" enabled="false">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_ULT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_ULT_PASS2" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />   
    </Stage>
    
    <Stage id="ApplyPostTaa" enabled="true" >

      <!-- async is done with MOTIONRESOLVE -->
      <SyncGraphicsToCompute compute="async_next" markerIndex="1" />

    </Stage>

    <Stage id="DepthOfFieldBokeh">
      <BeginTarget target="DOF_DOWNSAMPLE" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_ASYNC" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />             
     

      <BeginTarget target="DOF_MAXBUF_H" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_HOR" compute="async_next" />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_MAXBUF" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_MAXBUF_H" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_VER" compute="async_next" />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_BLURBUF1" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />    
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_ASYNC" bufIndex="0" />    
      <BindBuffer sampler="gBuffer3Map" sourceRT="DOF_MAXBUF" bufIndex="0" />    
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="8.0" b="8.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="POISSON" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
      <BeginTarget target="HDRBUF_1" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_BLURBUF1" bufIndex="1" />        
     <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" alphaToCoverage="false"/>         
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="BLEND_INVSRCA" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
    </Stage>

    <Stage id="DepthOfFieldBokehNew">
      <BeginTarget target="DOF_DOWNSAMPLE" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_ASYNC" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />          


      <!--
        Re-enable this (and a corresponding shader section) for nicer bokeh
      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_ASYNC" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />       
    -->   
     

      <BeginTarget target="DOF_MAXBUF_H" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_HOR" compute="async_next" />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_MAXBUF" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_MAXBUF_H" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_VER" compute="async_next" />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_BLURBUF1" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />    
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_ASYNC" bufIndex="0" />    
      <BindBuffer sampler="gBuffer3Map" sourceRT="DOF_MAXBUF" bufIndex="0" />    
      <BindBuffer sampler="gBuffer4Map" sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />   
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="8.0" b="8.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="POISSON_NEW" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
      <BeginTarget target="HDRBUF_1" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_BLURBUF1" bufIndex="1" />        
     <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" alphaToCoverage="false"/>         
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="BLEND_INVSRCA" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
    </Stage>

    <Stage id="DepthOfFieldBlur_ToneMap">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="FINAL_OR_DOF_TONEMAP" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="TONEMAP_DEPTH" compute="async_next" wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
   </Stage>

    <Stage id="DepthOfFieldBlur_ToneMap_4x"  enabled="false" >
      <ColourMask channels="RGBA"/>
      <BeginTarget target="FINAL_OR_DOF_TONEMAP" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="TONEMAP_DOWNSAMPLE4_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
   </Stage>

    <Stage id="DepthOfFieldBlur_ToneMap_16x"  enabled="false" >
      <ColourMask channels="RGBA"/>
      <BeginTarget target="FINAL_OR_DOF_TONEMAP" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="TONEMAP_DOWNSAMPLE16_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
   </Stage>
    
   <Stage id="DepthOfFieldBlur">
      <BeginTarget target="DOF_DOWNSAMPLE" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="FINAL_OR_DOF_TONEMAP" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_ASYNC" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />             
     
      <BeginTarget target="DOF_BLURBUF1" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_DOWNSAMPLE" />
      <ColourMask channels="RGBA"  colBuf1="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />    
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9_DISCARD"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
      
      <BeginTarget target="DOF_BLURBUF1" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />        
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9_DISCARD"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_DOWNSAMPLE" />
      <ColourMask channels="RGBA"  colBuf1="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />        
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.5" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9_DISCARD"  compute="async_next" />
      <UnbindBuffers />    
      <EndTarget flushCB="true" flushDB="false" />       
     
      <BeginTarget target="FINAL_OR_DOF_TONEMAP" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />        
     <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" alphaToCoverage="false"/>         
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="BLEND"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
    </Stage>
        
    <Stage id="NewBloomPost" enabled="true">            
      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="BLOOM_BLURBUF_8B" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_8A" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_8B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_8A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7_SQR"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_16" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />           

      <BeginTarget target="BLOOM_BLURBUF_64" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_32" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_64" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="1.5" d="4.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR_ADD"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_32" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="1.5" d="2.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR_ADD"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewBloomResolve" enabled="true">
      <BeginTarget target="BLOOM_FINALBUF" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BLOOM_BLURBUF_8A" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="BLOOM_BLURBUF_16" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="11.0" b="9.0" c="7.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLOOM_RESOLVE"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    
      <BeginTarget target="BLOOM_BLURBUF_4B" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_FINALBUF" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="2.5" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_FINALBUF" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="2.5" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewBloomExposure" enabled="true">
      <BeginTarget target="BLOOM_EXPBUF_B" />
      <BindBuffer sampler="gBufferMap"   sourceRT="BLOOM_BLURBUF_64"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="BLOOM_EXPBUF_A"    bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLOOM_EXPOSURE"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="BLOOM_EXPBUF_A" targetB="BLOOM_EXPBUF_B" />
    </Stage>

    <!-- Enable this stage when you disable bloom stages, to clear the bloom buffers -->
    <Stage id="NoBloom" enabled="false">
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_8A" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="BLOOM_BLURBUF_8B" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_64" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_FINALBUF" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />      
    
      <BeginTarget target="BLOOM_EXPBUF_A" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" /> 
    </Stage>

    
    <Stage id="LensFlare">
      <BeginTarget target="LENS_BLURBUF" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="LENS_BRIGHTBUF" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="LENS_SUNBUF_A"  bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="BRIGHT" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
     
      <BeginTarget target="LENS_FLAREBUF" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_BLURBUF" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="FEATURE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      
    </Stage>


    <Stage id="LensFlareAnamorphic">
      <BeginTarget target="LENS_ANABUF_A"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_BLURBUF"        bufIndex="1" />
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="ANAMORPH" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="LENS_ANABUF_B"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANABUF_A"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" d="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANABUF_A"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANABUF_B"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" d="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANABUF_B"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANABUF_A"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="1.0" d="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANARESBUF"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap"    sourceRT="LENS_ANABUF_B"         bufIndex="0" />
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="ANAMORPH_RESOLVE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_FLAREBUF"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="add" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANARESBUF"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" d="1.0"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_ADD" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>


    <Stage id="LensFlareResolve">      
      <BeginTarget target="LENSFINAL_OR_UI_COMBINE_BUF"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_FINALBUF"       bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="FINAL_OR_DOF_TONEMAP" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="LENS_FLAREBUF"        bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="BLOOM_EXPBUF_A"       bufIndex="0" />
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="COMBINE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    

    </Stage>

    <Stage id="SSR_CopyFrom" enabled="false">
      <BeginTarget target="SSR_REFL_0" mipLevel="0"/>
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

     <!-- 
     <Stage id="DLSS_APPLY" enabled="false">
      <ApplyDLSS inputRT="HDRBUF_0" outputRT="TAA_FRONT" depthRT="DEPTH" motionRT="GBUFFER" />
    </Stage> 
    -->

    <Stage id="ScreenEffect">                              
      <ColourMask channels="RGBA"/>
      <BeginTarget target="FINAL_OR_DOF_TONEMAP"/>
      <DiscardTargetContents colBuf0="true" />        
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="LENSFINAL_OR_UI_COMBINE_BUF" bufIndex="0" />
      <DrawQuadMT material="Materials/UI.material.mbin" context="SCREENEFFECT" width="1.0" height="1.0" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="LUTMaskSwap" enabled="false" >
      <SwapTargets targetA="LUT_MASK" targetB="LUT_MASK_FINAL" />
    </Stage>
      
    <Stage id="CombineNoAA_Async"  enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="FINAL_OR_DOF_TONEMAP"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="LUT_MASK_FINAL" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_NO_LUM" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="CombineHDRNoAA_Async"  enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="FINAL_OR_DOF_TONEMAP"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="LUT_MASK_FINAL" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINEHDR" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
              
    <Stage id="Combine">
      <BeginTarget target="FINAL" readOnlyDepth="true" />             
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="FINAL_OR_DOF_TONEMAP"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="LUT_MASK_FINAL"     bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="CombineNoAA"  enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="FINAL_OR_DOF_TONEMAP"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="LUT_MASK_FINAL"     bufIndex="0" />
      <!-- <BindBuffer sampler="gBuffer1Map" sourceRT="HDRBUF_1"        bufIndex="32" /> -->
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_AND_COPY_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="CombineHDRNoAA"  enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="FINAL_OR_DOF_TONEMAP"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="LUT_MASK_FINAL"     bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINEHDR_AND_COPY_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="LUTMaskSwapBack" enabled="false" >
      <SwapTargets targetA="LUT_MASK" targetB="LUT_MASK_FINAL" />
    </Stage> 
      
    <Stage id="FXAA" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="" readOnlyDepth="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" />

      <BindBuffer sampler="gBufferMap" sourceRT="FINAL"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="FINAL"  bufIndex="1" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH" bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FXAA" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="DLSS_MOTION" enabled="false">
      <BeginTarget target="MOTIONSCREEN" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="RG"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTIONRESOLVE" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="disabled" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTION_UV2SCREEN" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="DLSS_APPLY" enabled="false">           
      <ApplyDLSS inputRT="FINAL" outputRT="" depthRT="DEPTH" motionRT="MOTIONSCREEN" />      
    </Stage>

    <Stage id="LUTMaskCopy" enabled="false" >
      <BeginTarget target="LUT_MASK_FINAL" depthTarget="DEPTH" onlyStencil="true" />
      <ClearTarget colBuf0="true"  col_R="0.0" />
      <ColourMask channels="R" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="32" stencilMask="32" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLENDED_ABOVE"     bufIndex="1" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="UI">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="Materials/UI.material.mbin" context="BINOCS" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="sourceAlpha" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="Materials/UI.material.mbin" context="UI" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="DebugCombine" enabled="false">
      <BeginTarget target="FINAL" readOnlyDepth="true" />             
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="FINAL_OR_DOF_TONEMAP"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="LUT_MASK_FINAL"     bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="DebugHex" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>

      <ClearTarget depthBuf="false" colBuf0="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />      
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="CLOUDSHADOWS"        bufIndex="0" sRGBRead="0" />

      <BindBuffer sampler="gBuffer1Map"  sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer4Map"  sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer5Map"  sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer6Map"  sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer7Map"  sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer8Map"  sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer9Map"  sourceRT="CLOUDS_HIGH"       bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer10Map" sourceRT="CLOUDSHADOWS"      bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer11Map" sourceRT="LIGHTSHAFT"        bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer12Map" sourceRT="LIGHTSHAFT"        bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer13Map" sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer14Map" sourceRT="HBAOBUF"           bufIndex="0" sRGBRead="0" />

      <DrawQuadMT material="materials/Debug.material.mbin" context="HEX_SPLIT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="DebugQuad" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>
      <ClearTarget depthBuf="false" colBuf0="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />
      
      <!--a, b, c, d == 0.0             -> full    screen buffer       -->
      <!--a, b, c, d == 1.0             -> default main   quad   split -->
      <!--a          == 2.0             -> top     left   inner  split -->
      <!--b          == 2.0             -> top     right  inner  split -->
      <!--c          == 2.0             -> bottom  left   inner  split -->
      <!--d          == 2.0             -> bottom  right  inner  split -->
      <SetUniform material="materials/DebugQuadSplit.material.mbin" uniform="gDebugSplitVec4" a="1.0" b="1.0" c="1.0" d="1.0"/>
      
      <!--a                             -> zoom index                                   -->
      <!--a          == [0.0,   3.0]    -> zoom respective main buffer                  -->
      <!--a          == [0.000, 0.303]  -> zoom respective inner split buffer           -->
      <!--a          == 42.0            -> zoom all buffers                             -->
      <!--b                             -> zoom scale                                   -->
      <!--b          == [0.0, n)        -> zoom buffer with index 'a' by a factor of 'b'-->
      <!--c, d                          -> zoom offset                                  -->
      <!--c, d       == [0.0, 1.0]      -> offset uvs of buffer 'a' by vec2(c,d)        -->
      <SetUniform material="materials/DebugQuadSplit.material.mbin" uniform="gDebugZoomVec4"  a="0.0" b="1.0" c="0.0" d="0.0"/>
      
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      
      <!--MAIN SPLIT -->
      <BindBuffer sampler="gBuffer0Map"   sourceRT="MOTIONSCREEN"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="MOTIONRESOLVE"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="GBUFFER"                bufIndex="1" sRGBRead="0" />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="GBUFFER"                bufIndex="0" sRGBRead="0" />
      
      <!--A SPLIT - TOP LEFT -->
      <BindBuffer sampler="gBuffer000Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer001Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer002Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer003Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <!--B SPLIT - TOP RIGHT -->
      <BindBuffer sampler="gBuffer100Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer101Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer102Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer103Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <!--C SPLIT - BOTTOM LEFT -->
      <BindBuffer sampler="gBuffer200Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer201Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer202Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer203Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />      
      <!--D SPLIT - BOTTOM RIGHT -->
      <BindBuffer sampler="gBuffer300Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer301Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer302Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer303Map" sourceRT="HBAOBUF"                bufIndex="0" sRGBRead="0" />
      
      <DrawQuadMT material="materials/DebugQuadSplit.material.mbin" context="QUAD_SPLIT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="DebugGbuffer" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="0" />

      <DrawQuadMT material="materials/Debug.material.mbin" context="TEXTURED" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

   <Stage id="TAA_NONE_RESET" enabled="false">
      <SwapTargets targetA="HDRBUF_0" targetB="HDRBUF_1" />
    </Stage> 

    <Stage id="Reset States">
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <ColourMask channels="RGBA"/>
    </Stage>

  </CommandQueue>



</Pipeline>
